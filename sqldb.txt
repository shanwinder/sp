CREATE TABLE `users` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `student_id` VARCHAR(20) NOT NULL UNIQUE,
  `name` VARCHAR(100) NOT NULL,
  `class_level` VARCHAR(10) NOT NULL,
  `password` VARCHAR(255) NOT NULL,
  `role` ENUM('student', 'admin') DEFAULT 'student',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `games` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `code` VARCHAR(50) NOT NULL UNIQUE,     -- เช่น logic, sequence, pattern
  `title` VARCHAR(255) NOT NULL,          -- ชื่อบทหรือชื่อเกม
  `description` TEXT,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `stages` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `game_id` INT NOT NULL,
  `stage_number` INT NOT NULL,            -- ด่านที่เท่าไหร่
  `title` VARCHAR(255),
  `instruction` TEXT,
  `content_json` JSON,                    -- ใช้เก็บคำถามหรือรูปภาพในแต่ละด่าน
  FOREIGN KEY (`game_id`) REFERENCES `games`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `progress` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `user_id` INT NOT NULL,
  `stage_id` INT NOT NULL,
  `score` INT DEFAULT 0,
  `attempts` INT DEFAULT 1,
  `completed_at` DATETIME,
  UNIQUE KEY `user_stage_unique` (`user_id`, `stage_id`),
  FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`stage_id`) REFERENCES `stages`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `game_logs` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `user_id` INT NOT NULL,
  `stage_id` INT NOT NULL,
  `action` ENUM('start', 'submit', 'hint', 'pass', 'fail') NOT NULL,
  `detail` TEXT,                     -- เก็บคำตอบ หรือข้อความ
  `logged_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`stage_id`) REFERENCES `stages`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;